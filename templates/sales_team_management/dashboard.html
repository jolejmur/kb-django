<!-- templates/sales_team_management/dashboard.html -->
{% extends 'base/base.html' %}

{% block title %}Dashboard - Gesti√≥n de Equipos de Ventas{% endblock %}

{% block header %}Dashboard - Gesti√≥n de Equipos de Ventas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üéØ Dashboard de Gesti√≥n de Equipos</h1>
        <p class="text-gray-600">Panel de control para la gesti√≥n integral de equipos de ventas, jerarqu√≠as y estructura organizacional</p>
    </div>

    <!-- Alertas -->
    {% if alertas %}
    <div class="mb-8 space-y-4">
        {% for alerta in alertas %}
        <div class="{% if alerta.tipo == 'warning' %}bg-yellow-50 border-l-4 border-yellow-400{% elif alerta.tipo == 'info' %}bg-blue-50 border-l-4 border-blue-400{% endif %} p-4 rounded-r-lg">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    {% if alerta.tipo == 'warning' %}
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    {% elif alerta.tipo == 'info' %}
                        <i class="fas fa-info-circle text-blue-400"></i>
                    {% endif %}
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium {% if alerta.tipo == 'warning' %}text-yellow-800{% elif alerta.tipo == 'info' %}text-blue-800{% endif %}">
                        {{ alerta.titulo }}
                    </p>
                    <p class="text-sm {% if alerta.tipo == 'warning' %}text-yellow-700{% elif alerta.tipo == 'info' %}text-blue-700{% endif %}">
                        {{ alerta.mensaje }}
                    </p>
                </div>
                <div class="ml-auto">
                    <a href="{% url alerta.url %}" class="{% if alerta.tipo == 'warning' %}text-yellow-600 hover:text-yellow-800{% elif alerta.tipo == 'info' %}text-blue-600 hover:text-blue-800{% endif %} text-sm font-medium">
                        Revisar ‚Üí
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Estad√≠sticas principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Unidades Activas -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Unidades Activas</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_equipos_activos }}</p>
                    {% if stats.total_equipos_inactivos > 0 %}
                        <p class="text-xs text-gray-400">{{ stats.total_equipos_inactivos }} inactivas</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Total Miembros Activos -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-user-friends text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Miembros Activos</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_miembros_activos }}</p>
                    {% if stats.total_miembros_inactivos > 0 %}
                        <p class="text-xs text-gray-400">{{ stats.total_miembros_inactivos }} inactivos</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Relaciones Jer√°rquicas -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-sitemap text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Relaciones Jer√°rquicas</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_relaciones_jerarquicas }}</p>
                    <p class="text-xs text-gray-400">{{ stats.total_estructuras_comision }} comisiones</p>
                </div>
            </div>
        </div>

        <!-- Proyectos -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-building text-orange-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Proyectos Activos</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_proyectos }}</p>
                    <p class="text-xs text-gray-400">{{ stats.total_inmuebles }} inmuebles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribuci√≥n por Posiciones -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-sitemap mr-3 text-blue-600"></i>
            Distribuci√≥n por Posiciones en la Organizaci√≥n
        </h3>
        {% if position_stats %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {% for position_code, stats in position_stats.items %}
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            {% if position_code == 'MANAGER' %}
                                <i class="fas fa-user-tie text-white text-xl"></i>
                            {% elif position_code == 'SUPERVISOR' %}
                                <i class="fas fa-user-cog text-white text-xl"></i>
                            {% elif position_code == 'TEAM_LEAD' %}
                                <i class="fas fa-users-cog text-white text-xl"></i>
                            {% elif position_code == 'AGENT' %}
                                <i class="fas fa-handshake text-white text-xl"></i>
                            {% else %}
                                <i class="fas fa-user text-white text-xl"></i>
                            {% endif %}
                        </div>
                        <h4 class="font-semibold text-gray-900">{{ stats.name }}</h4>
                        <p class="text-2xl font-bold text-blue-700">{{ stats.activos }}</p>
                        <p class="text-sm text-blue-600">activos</p>
                        {% if stats.inactivos > 0 %}
                            <p class="text-xs text-gray-500">{{ stats.inactivos }} inactivos</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-users-slash text-gray-300 text-4xl mb-4"></i>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No hay posiciones configuradas</h4>
                <p class="text-gray-500">Configure tipos de posici√≥n para ver la distribuci√≥n</p>
            </div>
        {% endif %}
    </div>

    <!-- Distribuci√≥n por Tipos de Unidad -->
    {% if unit_type_distribution %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-chart-pie mr-3 text-green-600"></i>
            Distribuci√≥n por Tipos de Unidad
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% for unit_type in unit_type_distribution %}
                <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border border-green-100">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3">
                        {% if unit_type.unit_type == 'SALES' %}
                            <i class="fas fa-chart-line text-white text-xl"></i>
                        {% elif unit_type.unit_type == 'PORTFOLIO' %}
                            <i class="fas fa-briefcase text-white text-xl"></i>
                        {% elif unit_type.unit_type == 'MARKETING' %}
                            <i class="fas fa-bullhorn text-white text-xl"></i>
                        {% else %}
                            <i class="fas fa-building text-white text-xl"></i>
                        {% endif %}
                    </div>
                    <h4 class="font-semibold text-gray-900">{{ unit_type.unit_type|title }}</h4>
                    <p class="text-2xl font-bold text-green-700">{{ unit_type.count }}</p>
                    <p class="text-sm text-green-600">unidades</p>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Accesos r√°pidos -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Gesti√≥n de Unidades -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-users mr-3 text-blue-600"></i>
                Unidades Organizacionales
            </h3>
            <p class="text-gray-600 mb-4">Administra unidades y su estructura organizacional</p>
            <div class="space-y-2">
                <a href="{% url 'sales_team_management:equipos_list' %}"
                   class="block w-full bg-blue-50 hover:bg-blue-100 text-blue-700 text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üìã Ver Unidades
                </a>
                <a href="{% url 'sales_team_management:crear_equipo' %}"
                   class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    ‚ûï Crear Unidad
                </a>
            </div>
        </div>

        <!-- Gesti√≥n de Jerarqu√≠a -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-sitemap mr-3 text-green-600"></i>
                Jerarqu√≠a y Relaciones
            </h3>
            <p class="text-gray-600 mb-4">Administra relaciones jer√°rquicas y supervisi√≥n</p>
            <div class="space-y-2">
                <a href="{% url 'sales_team_management:jerarquia_list' %}"
                   class="block w-full bg-green-50 hover:bg-green-100 text-green-700 text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üèóÔ∏è Ver Jerarqu√≠a
                </a>
                <a href="{% url 'sales_team_management:analisis_jerarquia' %}"
                   class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üìä An√°lisis Jer√°rquico
                </a>
            </div>
        </div>

        <!-- Gesti√≥n de Comisiones -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-percent mr-3 text-orange-600"></i>
                Estructura de Comisiones
            </h3>
            <p class="text-gray-600 mb-4">Configura comisiones por unidad y posici√≥n</p>
            <div class="space-y-2">
                <a href="{% url 'sales_team_management:comisiones_equipos_list' %}"
                   class="block w-full bg-orange-50 hover:bg-orange-100 text-orange-700 text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üí∞ Ver Comisiones
                </a>
                <a href="{% url 'sales_team_management:comisiones_proyectos_list' %}"
                   class="block w-full bg-orange-600 hover:bg-orange-700 text-white text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üè¢ Proyectos
                </a>
            </div>
        </div>

        <!-- Supervisi√≥n Directa -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-eye mr-3 text-purple-600"></i>
                Supervisi√≥n Directa
            </h3>
            <p class="text-gray-600 mb-4">Gestiona supervisi√≥n especial y directa</p>
            <div class="space-y-2">
                <a href="{% url 'sales_team_management:supervision_directa_list' %}"
                   class="block w-full bg-purple-50 hover:bg-purple-100 text-purple-700 text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    üëÅÔ∏è Ver Supervisiones
                </a>
                <a href="{% url 'sales_team_management:supervision_directa_create' %}"
                   class="block w-full bg-purple-600 hover:bg-purple-700 text-white text-center py-2 px-4 rounded-lg font-medium transition-colors">
                    ‚ûï Crear Supervisi√≥n
                </a>
            </div>
        </div>
    </div>

    <!-- Rankings y Detalles -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Unidades Mejor Estructuradas -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-trophy mr-3 text-yellow-600"></i>
                Unidades Mejor Estructuradas
            </h3>
            {% if equipos_con_info %}
                <div class="space-y-4">
                    {% for item in equipos_con_info %}
                    <div class="flex items-center justify-between p-4 {% if item.has_commission_structure %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %} rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h4 class="font-medium text-gray-900">{{ item.unit.name }}</h4>
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ item.unit.unit_type|title }}
                                </span>
                                {% if item.has_commission_structure %}
                                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ‚úì Comisiones
                                    </span>
                                {% endif %}
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                                <div class="text-center">
                                    <div class="text-blue-600 font-semibold">{{ item.total_members }}</div>
                                    <div class="text-gray-500">Miembros</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-green-600 font-semibold">{{ item.hierarchy_relations_count }}</div>
                                    <div class="text-gray-500">Relaciones</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-purple-600 font-semibold">{{ item.completion_score }}</div>
                                    <div class="text-gray-500">Puntuaci√≥n</div>
                                </div>
                            </div>
                            {% if item.members_by_position %}
                                <div class="flex flex-wrap gap-1">
                                    {% for position_code, count in item.members_by_position.items %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                                            {{ count }} {{ position_code }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-2xl font-bold text-gray-900">{{ item.completion_score }}%</div>
                            <div class="text-xs text-gray-500">completitud</div>
                            <a href="{% url 'sales_team_management:equipo_detail' item.unit.pk %}"
                               class="text-xs text-blue-600 hover:text-blue-800 block mt-1">Ver detalles</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-users-slash text-gray-300 text-4xl mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">No hay unidades configuradas</h4>
                    <p class="text-gray-500">Crea tu primera unidad organizacional para comenzar</p>
                </div>
            {% endif %}
        </div>

        <!-- An√°lisis de Jerarqu√≠a -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-chart-network mr-3 text-indigo-600"></i>
                An√°lisis de Jerarqu√≠a
            </h3>
            {% if hierarchy_analysis %}
                <div class="space-y-4">
                    <!-- Estad√≠sticas generales -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <h4 class="font-medium text-indigo-900 mb-2">Estad√≠sticas Generales</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-2xl font-bold text-indigo-700">{{ hierarchy_analysis.total_relations }}</div>
                                <div class="text-indigo-600">Total Relaciones</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold {% if hierarchy_analysis.inconsistencies_count > 0 %}text-red-700{% else %}text-green-700{% endif %}">
                                    {{ hierarchy_analysis.inconsistencies_count }}
                                </div>
                                <div class="{% if hierarchy_analysis.inconsistencies_count > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    Inconsistencias
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tipos de relaci√≥n -->
                    {% if hierarchy_analysis.relation_type_stats %}
                        <div class="space-y-2">
                            <h4 class="font-medium text-gray-900">Tipos de Relaci√≥n</h4>
                            {% for relation_stat in hierarchy_analysis.relation_type_stats %}
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">{{ relation_stat.relation_type }}</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ relation_stat.count }}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Alertas de inconsistencias -->
                    {% if hierarchy_analysis.inconsistencies_count > 0 %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-medium text-red-900 mb-2 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Problemas Detectados
                            </h4>
                            <div class="text-sm text-red-700 space-y-1">
                                {% if hierarchy_analysis.circular_relations_count > 0 %}
                                    <div>‚Ä¢ {{ hierarchy_analysis.circular_relations_count }} relaci√≥n(es) circular(es)</div>
                                {% endif %}
                                {% if hierarchy_analysis.multiple_primary_supervisors_count > 0 %}
                                    <div>‚Ä¢ {{ hierarchy_analysis.multiple_primary_supervisors_count }} miembro(s) con m√∫ltiples supervisores primarios</div>
                                {% endif %}
                            </div>
                            <a href="{% url 'sales_team_management:analisis_jerarquia' %}" 
                               class="inline-block mt-2 text-xs text-red-600 hover:text-red-800 font-medium">
                                Ver detalles completos ‚Üí
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-chart-network text-gray-300 text-4xl mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Sin an√°lisis disponible</h4>
                    <p class="text-gray-500">Configure relaciones jer√°rquicas para ver el an√°lisis</p>
                </div>
            {% endif %}
        </div>

        <!-- Proyectos Activos -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-city mr-3 text-indigo-600"></i>
                Proyectos M√°s Activos
            </h3>
            {% if proyectos_activos %}
                <div class="space-y-4">
                    {% for proyecto in proyectos_activos %}
                    <div class="flex items-center justify-between p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div>
                            <h4 class="font-medium text-gray-900">{{ proyecto.nombre }}</h4>
                            <p class="text-sm text-gray-600">{{ proyecto.descripcion|truncatechars:40 }}</p>
                            <div class="flex items-center mt-2 space-x-4 text-xs">
                                <span class="text-indigo-600">
                                    <i class="fas fa-home mr-1"></i>
                                    {{ proyecto.total_inmuebles }} inmuebles
                                </span>
                                <span class="text-green-600">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    {{ proyecto.inmuebles_vendidos }} vendidos
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if proyecto.total_inmuebles > 0 %}
                                {% widthratio proyecto.inmuebles_vendidos proyecto.total_inmuebles 100 as porcentaje %}
                                <div class="text-lg font-bold text-green-600">{{ porcentaje }}%</div>
                                <div class="text-xs text-gray-500">vendido</div>
                            {% else %}
                                <div class="text-lg font-bold text-gray-400">0%</div>
                                <div class="text-xs text-gray-500">sin inmuebles</div>
                            {% endif %}
                            <a href="{% url 'sales_team_management:proyectos_detail' proyecto.pk %}"
                               class="text-xs text-blue-600 hover:text-blue-800 block mt-1">Ver detalles</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-building text-gray-300 text-4xl mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">No hay proyectos activos</h4>
                    <p class="text-gray-500">Crea tu primer proyecto para comenzar</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Animaciones suaves */
.hover\:shadow-md:hover {
    transition: box-shadow 0.3s ease;
}

.transition-shadow {
    transition: box-shadow 0.2s ease;
}

.transition-colors {
    transition: background-color 0.2s ease, color 0.2s ease;
}

/* Mejoras visuales para los iconos */
.fas {
    font-weight: 900;
}

/* Grid responsivo personalizado */
@media (max-width: 768px) {
    .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}