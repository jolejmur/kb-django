<!-- templates/sales_team_management/equipos/form.html -->
{% extends 'base/base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar Unidad Organizacional{% else %}Crear Unidad Organizacional{% endif %} - Korban
{% endblock %}

{% block header %}
    {% if form.instance.pk %}Editar Unidad Organizacional{% else %}Crear Unidad Organizacional{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-4 sm:mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 text-xs sm:text-sm md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'sales_team_management:equipos_list' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <i class="fas fa-building mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Unidades Organizacionales</span>
                    <span class="sm:hidden">Unidades</span>
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-1 sm:mx-2"></i>
                    <span class="text-sm font-medium text-gray-500">
                        {% if form.instance.pk %}Editar{% else %}Crear{% endif %}
                    </span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <h2 class="text-base sm:text-lg font-semibold text-gray-900">
                {% if form.instance.pk %}
                    <span class="hidden sm:inline">Editar Unidad: {{ form.instance.name }}</span>
                    <span class="sm:hidden">Editar: {{ form.instance.name|truncatechars:20 }}</span>
                {% else %}
                    <span class="hidden sm:inline">Nueva Unidad Organizacional</span>
                    <span class="sm:hidden">Nueva Unidad</span>
                {% endif %}
            </h2>
        </div>

        <form method="post" class="p-4 sm:p-6">
            {% csrf_token %}
            
            <!-- Mostrar errores generales -->
            {% if form.non_field_errors %}
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-400 mt-0.5 mr-2"></i>
                        <div>
                            <h3 class="text-sm font-medium text-red-800">Error en el formulario</h3>
                            <ul class="mt-1 text-sm text-red-600">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nombre -->
                <div class="md:col-span-2">
                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.name.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                    {% endif %}
                    {% if form.name.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.name.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Tipo de Unidad -->
                <div>
                    <label for="{{ form.unit_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.unit_type.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.unit_type }}
                    {% if form.unit_type.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.unit_type.errors.0 }}</p>
                    {% endif %}
                    {% if form.unit_type.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.unit_type.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Toggle para Estructura Jerárquica -->
                <div class="md:col-span-2">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="flex items-center" style="min-width: 40px;">
                                <input type="checkbox" 
                                       id="id_enable_hierarchy" 
                                       name="enable_hierarchy" 
                                       onclick="toggleParentUnit(this.checked)"
                                       {% if form.enable_hierarchy.value %}checked{% endif %}
                                       style="width: 25px !important; height: 25px !important; margin-right: 15px !important; transform: scale(1.2) !important; accent-color: #3b82f6 !important; cursor: pointer !important;">
                            </div>
                            <div class="flex-1 min-w-0">
                                <label for="id_enable_hierarchy" class="text-sm font-medium text-blue-900 cursor-pointer">
                                    {{ form.enable_hierarchy.label }}
                                </label>
                                <p class="text-sm text-blue-700">{{ form.enable_hierarchy.help_text }}</p>
                                <div class="mt-2 text-xs text-blue-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>¿Cuándo activar?</strong> Solo si esta unidad debe reportar a otra unidad organizacional superior
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unidad Padre (oculto por defecto) -->
                <div id="parent-unit-container" class="md:col-span-2" style="{% if not form.enable_hierarchy.value %}display: none;{% endif %}">
                    <label for="{{ form.parent_unit.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.parent_unit.label }}
                        <span class="text-blue-600 ml-1">(Opcional)</span>
                    </label>
                    {{ form.parent_unit }}
                    {% if form.parent_unit.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.parent_unit.errors.0 }}</p>
                    {% endif %}
                    <p class="mt-1 text-sm text-gray-500">
                        <i class="fas fa-sitemap mr-1"></i>
                        Selecciona la unidad organizacional a la que reportará esta unidad
                    </p>
                </div>

                <!-- Descripción -->
                <div class="md:col-span-2">
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.description.label }}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                    {% endif %}
                    {% if form.description.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.description.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Estado Activo -->
                <div>
                    <label class="flex items-center">
                        {{ form.is_active }}
                        <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_active.label }}</span>
                    </label>
                    {% if form.is_active.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.is_active.errors.0 }}</p>
                    {% endif %}
                    {% if form.is_active.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.is_active.help_text }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="mt-8 flex items-center justify-between pt-6 border-t border-gray-200">
                <a href="{% url 'sales_team_management:equipos_list' %}" 
                   class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
                
                <div class="flex space-x-3">
                    {% if form.instance.pk %}
                        <a href="{% url 'sales_team_management:equipo_detail' form.instance.pk %}" 
                           class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-eye mr-2"></i>Ver Detalles
                        </a>
                    {% endif %}
                    
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        {% if form.instance.pk %}Actualizar{% else %}Crear{% endif %} Unidad
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Información adicional para unidades existentes -->
    {% if form.instance.pk %}
        <div class="mt-6 bg-blue-50 rounded-xl border border-blue-200 p-4">
            <h3 class="text-sm font-medium text-blue-900 mb-2">Próximos pasos</h3>
            <ul class="text-sm text-blue-800 space-y-1">
                <li>• <a href="{% url 'sales_team_management:jerarquia_create' %}" class="underline hover:no-underline">Agregar miembros a la unidad</a></li>
                <li>• <a href="{% url 'sales_team_management:jerarquia_equipo' form.instance.pk %}" class="underline hover:no-underline">Establecer relaciones jerárquicas</a></li>
                <li>• <a href="{% url 'sales_team_management:comisiones_equipo_config' form.instance.pk %}" class="underline hover:no-underline">Configurar estructura de comisiones</a></li>
            </ul>
        </div>
    {% endif %}

    <!-- Información sobre tipos de unidad y jerarquía -->
    <div class="mt-6 space-y-6">
        <!-- Tipos de unidades -->
        <div class="bg-gray-50 rounded-xl border border-gray-200 p-4">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Tipos de Unidades Organizacionales</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="flex items-start space-x-2">
                    <i class="fas fa-chart-line text-blue-600 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">Ventas</p>
                        <p class="text-gray-600">Unidades enfocadas en comercialización y ventas directas</p>
                    </div>
                </div>
                <div class="flex items-start space-x-2">
                    <i class="fas fa-briefcase text-purple-600 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">Cartera</p>
                        <p class="text-gray-600">Gestión de cartera de clientes y post-venta</p>
                    </div>
                </div>
                <div class="flex items-start space-x-2">
                    <i class="fas fa-bullhorn text-orange-600 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">Marketing</p>
                        <p class="text-gray-600">Estrategias de marketing y generación de leads</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información sobre estructura jerárquica -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-4">
            <div class="flex items-start space-x-3">
                <i class="fas fa-sitemap text-blue-600 mt-1"></i>
                <div>
                    <h3 class="text-sm font-medium text-blue-900 mb-2">💡 Estructura Jerárquica (Funcionalidad Avanzada)</h3>
                    <p class="text-sm text-blue-800 mb-3">
                        La funcionalidad de jerarquía te permite crear estructuras organizacionales complejas cuando tu empresa crezca.
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-medium text-blue-900 mb-1">✅ Estructura Simple (Recomendado inicialmente):</p>
                            <ul class="text-blue-700 space-y-1 ml-4">
                                <li>• Equipo Ventas Norte</li>
                                <li>• Equipo Ventas Sur</li>
                                <li>• Equipo Carteras</li>
                                <li>• <em>Cada uno independiente</em></li>
                            </ul>
                        </div>
                        
                        <div>
                            <p class="font-medium text-blue-900 mb-1">🏢 Estructura Jerárquica (Futuro):</p>
                            <ul class="text-blue-700 space-y-1 ml-4">
                                <li>• División Ventas</li>
                                <li>&nbsp;&nbsp;└ Equipo Norte</li>
                                <li>&nbsp;&nbsp;└ Equipo Sur</li>
                                <li>• División Carteras</li>
                                <li>&nbsp;&nbsp;└ Cartera Residencial</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 bg-blue-100 rounded-lg">
                        <p class="text-xs text-blue-800">
                            <i class="fas fa-lightbulb mr-1"></i>
                            <strong>Consejo:</strong> Mantén desactivada la jerarquía mientras tengas equipos independientes. 
                            Actívala cuando necesites reportes consolidados o estructuras de autoridad complejas.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* FORZAR márgenes visibles con !important */
input[type="text"], textarea, select {
    margin: 15px 0 !important;
    padding: 10px 12px !important;
    border: 2px solid #d1d5db !important;
    border-radius: 8px !important;
    width: 100% !important;
    font-size: 14px !important;
    background-color: white !important;
    transition: all 0.2s ease !important;
}

input[type="text"]:focus, textarea:focus, select:focus {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    outline: none !important;
}

/* FORZAR estilos del select */
select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") !important;
    background-position: right 0.75rem center !important;
    background-repeat: no-repeat !important;
    background-size: 1.25em 1.25em !important;
    padding-right: 2.5rem !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
}

select::-ms-expand {
    display: none !important;
}

textarea {
    min-height: 100px !important;
    resize: vertical !important;
}

/* FORZAR visibilidad del checkbox toggle */
#id_enable_hierarchy {
    width: 20px !important;
    height: 20px !important;
    margin-right: 15px !important;
    transform: scale(1.5) !important;
    accent-color: #3b82f6 !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 10 !important;
}

input[type="checkbox"] {
    width: 16px !important;
    height: 16px !important;
    margin-right: 8px !important;
    accent-color: #3b82f6 !important;
}

/* MOBILE: Arreglar select completamente */
@media (max-width: 768px) {
    select, #id_unit_type, .form-control {
        font-size: 16px !important;
        min-height: 50px !important;
        padding: 12px 16px !important;
        padding-right: 45px !important;
        background-size: 24px 24px !important;
        background-position: right 15px center !important;
        border: 3px solid #d1d5db !important;
        border-radius: 10px !important;
        position: static !important;
        z-index: auto !important;
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        transform: none !important;
        top: auto !important;
        left: auto !important;
        right: auto !important;
        bottom: auto !important;
        margin: 15px 0 !important;
        float: none !important;
        clear: both !important;
    }
    
    select:focus, #id_unit_type:focus, .form-control:focus {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2) !important;
        position: static !important;
        z-index: auto !important;
    }
    
    /* Específico para el select de unit_type */
    #id_unit_type {
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        transform: none !important;
        margin: 15px 0 !important;
        display: block !important;
        width: 100% !important;
        z-index: 1 !important;
    }
    
    /* Forzar que las opciones aparezcan correctamente */
    select option, #id_unit_type option {
        font-size: 16px !important;
        padding: 12px 16px !important;
        background-color: white !important;
        color: black !important;
        border: none !important;
        min-height: 44px !important;
        line-height: 1.4 !important;
        position: static !important;
        transform: none !important;
    }
    
    input[type="text"], textarea {
        font-size: 16px !important;
        min-height: 50px !important;
        padding: 12px 16px !important;
        border: 3px solid #d1d5db !important;
        border-radius: 10px !important;
    }
    
    #id_enable_hierarchy {
        width: 30px !important;
        height: 30px !important;
        transform: scale(1.5) !important;
        margin-right: 20px !important;
    }
    
    textarea {
        min-height: 100px !important;
    }
    
    /* Asegurar que los labels estén correctamente posicionados */
    label {
        display: block !important;
        margin-bottom: 8px !important;
        position: relative !important;
        z-index: 1 !important;
    }
    
    /* Contenedor padre del select para asegurar flujo normal */
    .grid > div {
        position: relative !important;
        z-index: auto !important;
        overflow: visible !important;
    }
}

/* Animación suave para mostrar/ocultar el campo */
#parent-unit-container {
    transition: all 0.3s ease !important;
}

.fade-in {
    animation: fadeIn 0.3s ease-in !important;
}

.fade-out {
    animation: fadeOut 0.3s ease-out !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}
</style>

<script>
function toggleParentUnit(isEnabled) {
    const container = document.getElementById('parent-unit-container');
    const parentUnitSelect = document.getElementById('id_parent_unit');
    
    if (isEnabled) {
        // Mostrar el campo con animación
        container.style.display = 'block';
        container.classList.add('fade-in');
        container.classList.remove('fade-out');
        
        // Hacer el campo disponible para validación
        parentUnitSelect.disabled = false;
    } else {
        // Ocultar el campo con animación
        container.classList.add('fade-out');
        container.classList.remove('fade-in');
        
        // Limpiar la selección y deshabilitar
        parentUnitSelect.value = '';
        parentUnitSelect.disabled = true;
        
        // Ocultar después de la animación
        setTimeout(() => {
            if (!document.getElementById('id_enable_hierarchy').checked) {
                container.style.display = 'none';
            }
        }, 300);
    }
}

// Configurar el estado inicial cuando carga la página
document.addEventListener('DOMContentLoaded', function() {
    const enableHierarchyCheckbox = document.getElementById('id_enable_hierarchy');
    const parentUnitContainer = document.getElementById('parent-unit-container');
    
    // Configurar el estado inicial basado en el checkbox
    if (enableHierarchyCheckbox) {
        // Si está marcado al cargar (por ejemplo, al editar), mostrar el campo
        const isEnabled = enableHierarchyCheckbox.checked;
        if (isEnabled) {
            parentUnitContainer.style.display = 'block';
        } else {
            parentUnitContainer.style.display = 'none';
        }
        
        // Agregar event listener para futuros cambios
        enableHierarchyCheckbox.addEventListener('change', function() {
            toggleParentUnit(this.checked);
        });
    }
});
</script>
{% endblock %}