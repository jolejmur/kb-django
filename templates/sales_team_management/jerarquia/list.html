<!-- templates/sales_team_management/jerarquia/list.html -->
{% extends 'base/base.html' %}

{% block title %}Jerarquía de Equipos - Korban{% endblock %}

{% block header %}Jerarquía de Equipos{% endblock %}

<!-- TEMPLATE UPDATED: {{ "now"|date:"Y-m-d H:i:s" }} -->

{% block extra_css %}
<style>
/* Prevenir scroll horizontal */
body, html {
    overflow-x: hidden;
}

/* Asegurar que las tablas no generen scroll horizontal */
.table-container {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

/* Ajustes específicos para diferentes tamaños de pantalla */
@media (min-width: 1536px) {
    /* 2XL: Monitores grandes */
    .responsive-container {
        max-width: none;
        padding-left: 3rem;
        padding-right: 3rem;
    }
}

@media (min-width: 1280px) and (max-width: 1535px) {
    /* XL: Laptops grandes */
    .responsive-container {
        max-width: none;
        padding-left: 2rem;
        padding-right: 2rem;
    }
}

@media (min-width: 1024px) and (max-width: 1279px) {
    /* LG: Laptops */
    .responsive-container {
        max-width: none;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
}

@media (min-width: 768px) and (max-width: 1023px) {
    /* MD: Tablets */
    .responsive-container {
        max-width: none;
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (max-width: 767px) {
    /* SM/Mobile */
    .responsive-container {
        max-width: none;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
    
    /* Asegurar que no haya scroll horizontal en móvil */
    .md\\:hidden {
        width: 100%;
        overflow-x: hidden;
    }
    
    /* Forzar que el contenido se ajuste al ancho disponible */
    .md\\:hidden .divide-y > div {
        width: 100%;
        min-width: 0;
    }
}

/* Asegurar que el texto se trunca correctamente */
.truncate-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
    flex: 1;
}

/* Mejorar la legibilidad en tablets */
@media (min-width: 768px) and (max-width: 1023px) {
    .tablet-card {
        min-height: 200px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="responsive-container w-full max-w-none px-3 sm:px-4 lg:px-6 xl:px-8 2xl:px-12">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Jerarquía de Equipos</h1>
            <p class="text-gray-600 mt-1 text-sm sm:text-base">Vista completa de todos los equipos y sus relaciones jerárquicas</p>
        </div>
        <div class="flex">
            <a href="{% url 'sales_team_management:jerarquia_create' %}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center transition-colors">
                <i class="fas fa-plus mr-2"></i>
                <span class="hidden sm:inline">Crear Relación</span>
                <span class="sm:hidden">Crear</span>
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <!-- Búsqueda en tiempo real -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="search-input"
                           placeholder="Buscar por nombre, email, unidad organizacional..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Filtro por Fuerza de Venta -->
                <div class="w-full sm:w-64">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fuerza de Venta</label>
                    <select id="unit-filter" 
                            {% if not can_change_filter %}disabled readonly{% endif %}
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none
                            {% if not can_change_filter %}bg-gray-100 cursor-not-allowed{% else %}bg-white{% endif %}">
                        {% if can_change_filter %}
                            <option value="">Todas las fuerzas de venta</option>
                        {% endif %}
                        {% for unit in units %}
                            <option value="{{ unit.id }}" {% if unit.id|stringformat:"s" == equipo_filter %}selected{% endif %}>
                                {{ unit.name }}
                                {% if not can_change_filter %} (Tu equipo){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    {% if not can_change_filter %}
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-lock mr-1"></i>Solo puedes ver la jerarquía de tu equipo
                        </p>
                    {% endif %}
                </div>

                <!-- Selector de elementos por página -->
                <div class="w-full sm:w-32">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Por página</label>
                    <select id="page-size-selector" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white">
                        {% for size in page_size_options %}
                            <option value="{{ size }}" {% if size == current_page_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Indicador de búsqueda -->
            <div id="search-indicator" class="hidden mt-4">
                <div class="flex items-center text-sm text-blue-600">
                    <i class="fas fa-search mr-2"></i>
                    <span>Buscando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    {% if stats %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
            <div class="flex items-center">
                <div class="p-1.5 sm:p-2 bg-blue-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-sitemap text-blue-600 text-sm sm:text-base"></i>
                </div>
                <div class="ml-2 sm:ml-3 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Relaciones</p>
                    <p class="text-sm sm:text-lg font-semibold text-gray-900">{{ stats.total_relations }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
            <div class="flex items-center">
                <div class="p-1.5 sm:p-2 bg-green-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-check-circle text-green-600 text-sm sm:text-base"></i>
                </div>
                <div class="ml-2 sm:ml-3 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">Activas</p>
                    <p class="text-sm sm:text-lg font-semibold text-gray-900">{{ stats.active_relations }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
            <div class="flex items-center">
                <div class="p-1.5 sm:p-2 bg-purple-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-magic text-purple-600 text-sm sm:text-base"></i>
                </div>
                <div class="ml-2 sm:ml-3 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">Directas</p>
                    <p class="text-sm sm:text-lg font-semibold text-gray-900">{{ stats.direct_relations }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
            <div class="flex items-center">
                <div class="p-1.5 sm:p-2 bg-orange-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-building text-orange-600 text-sm sm:text-base"></i>
                </div>
                <div class="ml-2 sm:ml-3 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">Unidades</p>
                    <p class="text-sm sm:text-lg font-semibold text-gray-900">{{ stats.units_with_relations }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-4">
            <div class="flex items-center">
                <div class="p-1.5 sm:p-2 bg-red-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-600 text-sm sm:text-base"></i>
                </div>
                <div class="ml-2 sm:ml-3 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">Inconsistencias</p>
                    <p class="text-sm sm:text-lg font-semibold text-gray-900">{{ stats.inconsistencies|default:0 }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Relaciones -->
    <div id="relations-container" class="bg-white rounded-xl shadow-sm border border-gray-200">
        {% include 'sales_team_management/jerarquia/partials/relations_list.html' %}
    </div>

    <!-- Paginación -->
    <div id="pagination-container" class="mt-6 flex justify-center">
        {% if page_obj.has_other_pages %}
            {% include 'sales_team_management/jerarquia/partials/pagination.html' %}
        {% endif %}
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div id="no-results" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 text-center py-12">
        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron resultados</h3>
        <p class="text-gray-500 mb-6">Intenta con otros términos de búsqueda o ajusta los filtros.</p>
        <button onclick="clearSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium inline-flex items-center">
            <i class="fas fa-times mr-2"></i>Limpiar búsqueda
        </button>
    </div>
</div>

<script>
let searchTimeout;
let currentSearch = '';
let currentUnitFilter = '';
let currentPage = 1;
let currentPageSize = {{ current_page_size }};

// Control de acceso
const canChangeFilter = {{ can_change_filter|yesno:"true,false" }};
const isTeamMember = {{ is_team_member|yesno:"true,false" }};
const userTeamFilter = "{{ equipo_filter }}";

// Clave para localStorage
const FILTERS_STORAGE_KEY = 'hierarchy_filters';

// Función para guardar filtros en localStorage
function saveFiltersToStorage(filters) {
    try {
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(filters));
    } catch (e) {
        console.warn('No se pudo guardar filtros en localStorage:', e);
    }
}

// Función para cargar filtros desde localStorage
function loadFiltersFromStorage() {
    try {
        const saved = localStorage.getItem(FILTERS_STORAGE_KEY);
        return saved ? JSON.parse(saved) : {};
    } catch (e) {
        console.warn('No se pudo cargar filtros desde localStorage:', e);
        return {};
    }
}

// Función para aplicar filtros guardados
function applySavedFilters() {
    const saved = loadFiltersFromStorage();
    
    // Aplicar valores a los elementos del formulario
    if (saved.search) {
        document.getElementById('search-input').value = saved.search;
        currentSearch = saved.search;
    }
    
    // Para miembros de equipo, FORZAR el filtro de su equipo
    if (isTeamMember && !canChangeFilter) {
        const unitSelect = document.getElementById('unit-filter');
        if (unitSelect) {
            unitSelect.value = userTeamFilter;
            currentUnitFilter = userTeamFilter;
        }
    } else if (saved.unitFilter && canChangeFilter) {
        const unitSelect = document.getElementById('unit-filter');
        if (unitSelect) {
            unitSelect.value = saved.unitFilter;
            currentUnitFilter = saved.unitFilter;
        }
    }
    
    if (saved.pageSize) {
        const pageSizeSelect = document.getElementById('page-size-selector');
        if (pageSizeSelect) {
            pageSizeSelect.value = saved.pageSize;
            currentPageSize = saved.pageSize;
        }
    }
    
    // Si hay filtros aplicados, ejecutar búsqueda
    const effectiveUnitFilter = isTeamMember ? userTeamFilter : (saved.unitFilter || '');
    if (saved.search || effectiveUnitFilter) {
        searchHierarchy(saved.search || '', effectiveUnitFilter, 1, saved.pageSize || currentPageSize);
    }
}

// Función principal de búsqueda
function searchHierarchy(query = '', unitFilter = '', page = 1, pageSize = null) {
    const searchIndicator = document.getElementById('search-indicator');
    const relationsContainer = document.getElementById('relations-container');
    const paginationContainer = document.getElementById('pagination-container');
    const noResults = document.getElementById('no-results');
    
    // Mostrar indicador de búsqueda
    searchIndicator.classList.remove('hidden');
    
    // Construir URL
    const url = new URL('{% url "sales_team_management:ajax_search_hierarchy" %}', window.location.origin);
    const params = new URLSearchParams();
    
    if (query) params.append('q', query);
    if (unitFilter) params.append('unit_filter', unitFilter);
    if (page > 1) params.append('page', page);
    if (pageSize && pageSize !== 10) params.append('page_size', pageSize);
    
    url.search = params.toString();
    
    // Actualizar variables globales
    currentSearch = query;
    currentUnitFilter = unitFilter;
    currentPage = page;
    if (pageSize) currentPageSize = pageSize;
    
    // Guardar filtros en localStorage
    saveFiltersToStorage({
        search: query,
        unitFilter: unitFilter,
        pageSize: pageSize || currentPageSize
    });
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Ocultar indicador de búsqueda
            searchIndicator.classList.add('hidden');
            
            // Debug temporal
            console.log('AJAX Response:', data);
            
            if (data.success) {
                if (data.total_results > 0) {
                    // Mostrar resultados
                    relationsContainer.innerHTML = data.relations_html;
                    paginationContainer.innerHTML = data.pagination_html;
                    
                    // Ocultar mensaje de no resultados
                    noResults.classList.add('hidden');
                    relationsContainer.classList.remove('hidden');
                } else {
                    // Mostrar mensaje de no resultados
                    relationsContainer.classList.add('hidden');
                    paginationContainer.innerHTML = '';
                    noResults.classList.remove('hidden');
                }
            } else {
                console.error('Error en la búsqueda:', data.message);
            }
        })
        .catch(error => {
            console.error('Error en la solicitud AJAX:', error);
            searchIndicator.classList.add('hidden');
        });
}

// Función para limpiar búsqueda
function clearSearch() {
    // Limpiar formulario
    document.getElementById('search-input').value = '';
    document.getElementById('unit-filter').value = '';
    
    // Limpiar localStorage
    localStorage.removeItem(FILTERS_STORAGE_KEY);
    
    // Ejecutar búsqueda vacía
    searchHierarchy('', '', 1, currentPageSize);
}

// Función para cambiar el tamaño de página
function changePageSize(newSize) {
    // Usar AJAX en lugar de recargar la página para mantener filtros
    currentPageSize = newSize;
    
    // Guardar el nuevo tamaño en localStorage
    const saved = loadFiltersFromStorage();
    saved.pageSize = newSize;
    saveFiltersToStorage(saved);
    
    // Ejecutar búsqueda con filtros actuales y nuevo tamaño de página
    searchHierarchy(currentSearch, currentUnitFilter, 1, newSize);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const unitFilter = document.getElementById('unit-filter');
    const pageSizeSelector = document.getElementById('page-size-selector');
    
    // Aplicar filtros guardados al cargar la página
    applySavedFilters();
    
    // Búsqueda en tiempo real con debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        const unitFilterValue = unitFilter.value;
        
        searchTimeout = setTimeout(() => {
            searchHierarchy(query, unitFilterValue, 1, currentPageSize);
        }, 500); // 500ms de delay
    });
    
    // Filtro por unidad organizacional (solo si puede cambiar)
    if (canChangeFilter) {
        unitFilter.addEventListener('change', function() {
            const query = searchInput.value.trim();
            const unitFilterValue = this.value;
            searchHierarchy(query, unitFilterValue, 1, currentPageSize);
        });
    } else {
        // Para miembros de equipo, evitar que cambien el filtro
        unitFilter.addEventListener('change', function() {
            // Revertir al filtro del equipo si intentan cambiarlo
            if (this.value !== userTeamFilter) {
                this.value = userTeamFilter;
                console.warn('No puedes cambiar el filtro de equipo');
            }
        });
    }

    // Selector de elementos por página
    pageSizeSelector.addEventListener('change', function() {
        const newSize = this.value;
        changePageSize(newSize);
    });
});
</script>
{% endblock %}