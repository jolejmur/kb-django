<!-- templates/sales_team_management/jerarquia/create.html -->
{% extends 'base/base.html' %}

{% block title %}Agregar Miembro al Equipo - Korban{% endblock %}

{% block header %}Agregar Miembro al Equipo{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS para el mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript para el mapa -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'sales_team_management:jerarquia_list' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <i class="fas fa-sitemap mr-2"></i>
                    Jerarquía Organizacional
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-sm font-medium text-gray-500">Agregar Miembro</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Agregar Miembro al Equipo</h1>
            <p class="text-gray-600">Busca un usuario existente o crea uno nuevo y asígnalo a un equipo con su rol correspondiente</p>
        </div>
        <a href="{% url 'sales_team_management:jerarquia_list' %}" 
           class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Cancelar
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Paso 1: Buscar o Crear Usuario -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Paso 1: Seleccionar Usuario</h2>
                </div>

                <div class="p-4 sm:p-6 space-y-6">
                    <!-- Buscador de Usuarios -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Buscar Usuario Existente
                        </label>
                        <div class="relative">
                            <input type="text" 
                                   id="user-search" 
                                   placeholder="Escribe nombre, apellido o username..."
                                   class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <i class="fas fa-search absolute right-3 top-3.5 text-gray-400"></i>
                        </div>
                        
                        <!-- Resultados de búsqueda -->
                        <div id="search-results" class="mt-3 hidden">
                            <div class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                                <!-- Los resultados se llenan con JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Usuario seleccionado -->
                        <div id="selected-user" class="mt-3 hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-user text-green-600 mr-3"></i>
                                        <div>
                                            <p class="font-medium text-green-900" id="selected-user-name"></p>
                                            <p class="text-sm text-green-700" id="selected-user-info"></p>
                                        </div>
                                    </div>
                                    <button type="button" id="clear-selection" class="text-green-600 hover:text-green-800">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">O</span>
                            </div>
                        </div>
                    </div>

                    <!-- Crear Nuevo Usuario -->
                    <div>
                        <button type="button" 
                                id="create-user-btn" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Crear Nuevo Usuario
                        </button>
                    </div>

                    <!-- Sin Usuario Seleccionado -->
                    <div id="no-user-selected" class="text-center py-8">
                        <i class="fas fa-user-slash text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Busca un usuario existente o crea uno nuevo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 2: Asignar Equipo y Rol -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Paso 2: Asignación</h2>
                </div>

                <div class="p-4 sm:p-6">
                    <form id="assignment-form" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" id="selected-user-id" name="user_id" value="">
                        
                        <!-- Seleccionar Equipo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Equipo <span class="text-red-500">*</span>
                            </label>
                            <select id="team-select" name="team_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Seleccionar equipo...</option>
                                {% for equipo in equipos %}
                                <option value="{{ equipo.id }}">{{ equipo.name }} ({{ equipo.get_unit_type_display }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Seleccionar Rol -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rol en el Equipo <span class="text-red-500">*</span>
                            </label>
                            <select id="role-select" name="position_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Seleccionar rol...</option>
                                <!-- Se llena dinámicamente con JavaScript -->
                            </select>
                        </div>

                        <!-- Tipo de Asignación -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Asignación
                            </label>
                            <select name="assignment_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="PERMANENT">Permanente</option>
                                <option value="TEMPORARY">Temporal</option>
                                <option value="PROJECT">Por Proyecto</option>
                            </select>
                        </div>

                        <!-- Supervisión Directa -->
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" name="direct_supervision" id="direct-supervision" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm font-medium text-gray-700">Supervisión Directa</span>
                            </label>
                            <p class="mt-1 text-xs text-gray-500">Marcar si este miembro tendrá supervisión directa sobre otros</p>
                        </div>

                        <!-- Supervisor (si aplica) -->
                        <div id="supervisor-selection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Supervisor
                            </label>
                            <select name="supervisor_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sin supervisor directo</option>
                                <!-- Se llena dinámicamente con JavaScript -->
                            </select>
                        </div>

                        <!-- Notas -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Notas (Opcional)
                            </label>
                            <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Información adicional sobre la asignación..."></textarea>
                        </div>

                        <!-- Botón de Crear -->
                        <button type="submit" 
                                id="create-assignment-btn"
                                disabled
                                class="w-full bg-gray-300 text-gray-500 px-4 py-3 rounded-lg font-medium cursor-not-allowed">
                            <i class="fas fa-plus mr-2"></i>Agregar al Equipo
                        </button>
                    </form>
                </div>
            </div>

            <!-- Resumen de la Asignación -->
            <div id="assignment-summary" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                <h3 class="text-sm font-medium text-blue-900 mb-2">Resumen de Asignación</h3>
                <div class="text-sm text-blue-700 space-y-1">
                    <p><strong>Usuario:</strong> <span id="summary-user"></span></p>
                    <p><strong>Equipo:</strong> <span id="summary-team"></span></p>
                    <p><strong>Rol:</strong> <span id="summary-role"></span></p>
                    <p><strong>Supervisión:</strong> <span id="summary-supervision"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Usuario -->
<div id="create-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Crear Nuevo Usuario</h3>
                <button type="button" id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="create-user-form" class="space-y-6">
                {% csrf_token %}
                
                <!-- Información Básica -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-md font-medium text-gray-900 mb-3">Información Básica</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Nombre <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="first_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Apellido <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="last_name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Username <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Cédula de Identidad
                            </label>
                            <input type="text" name="cedula" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Teléfono
                            </label>
                            <input type="tel" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Fecha de Nacimiento
                            </label>
                            <input type="date" name="fecha_nacimiento" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Contraseña Temporal <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">El usuario deberá cambiar esta contraseña en su primer acceso</p>
                        </div>
                    </div>
                </div>

                <!-- Información de Dirección -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-md font-medium text-gray-900 mb-3">Dirección y Ubicación</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Dirección Completa
                            </label>
                            <textarea name="domicilio" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Dirección completa del domicilio"></textarea>
                        </div>
                        
                        <!-- Mapa para seleccionar ubicación -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ubicación Geográfica (Opcional)
                            </label>
                            <div class="border border-gray-300 rounded-lg overflow-hidden">
                                <div id="user-location-map" style="height: 300px; width: 100%;"></div>
                            </div>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Latitud</label>
                                    <input type="number" name="latitud" id="user-latitude" step="0.0000001" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" readonly>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Longitud</label>
                                    <input type="number" name="longitud" id="user-longitude" step="0.0000001" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" readonly>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en el mapa para seleccionar la ubicación</p>
                        </div>

                        <!-- Foto de Perfil -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Foto de Perfil (Opcional)
                            </label>
                            <input type="file" name="foto_perfil" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div id="photo-preview" class="mt-2 hidden">
                                <img id="preview-image" src="" alt="Vista previa" class="h-20 w-20 object-cover rounded-lg border border-gray-300">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Selecciona una imagen JPG, PNG o GIF (máximo 5MB)</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-create-user" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Variables globales
let selectedUser = null;
let availablePositions = [];
let userLocationMap = null;
let userLocationMarker = null;

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    initializeUserSearch();
    initializeModalHandlers();
    initializeFormHandlers();
    initializePhotoPreview();
});

// Funciones de búsqueda de usuarios
function initializeUserSearch() {
    const searchInput = document.getElementById('user-search');
    const searchResults = document.getElementById('search-results');
    
    if (!searchInput) {
        console.error('Search input not found!');
        return;
    }
    
    if (!searchResults) {
        console.error('Search results container not found!');
        return;
    }
    
    console.log('User search initialized successfully');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        console.log('Input changed, query:', query);
        
        if (query.length < 1) {
            searchResults.classList.add('hidden');
            return;
        }

        searchTimeout = setTimeout(() => {
            searchUsers(query);
        }, 150);
    });
}

async function searchUsers(query) {
    console.log('Searching users with query:', query);
    try {
        const url = `{% url 'sales_team_management:ajax_search_users' %}?q=${encodeURIComponent(query)}`;
        console.log('Fetching URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            console.error('Response not OK:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error response body:', errorText);
            return;
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            console.log('Found users:', data.users);
            displaySearchResults(data.users);
        } else {
            console.error('Search failed:', data);
        }
    } catch (error) {
        console.error('Error searching users:', error);
    }
}

function displaySearchResults(users) {
    const searchResults = document.getElementById('search-results');
    const resultsContainer = searchResults.querySelector('div') || searchResults.appendChild(document.createElement('div'));
    resultsContainer.className = 'border border-gray-200 rounded-lg max-h-60 overflow-y-auto';
    
    if (users.length === 0) {
        resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">No se encontraron usuarios</div>';
    } else {
        resultsContainer.innerHTML = users.map(user => `
            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" onclick="selectUser(${user.id}, '${user.full_name}', '${user.username}', '${user.email}')">
                <div class="flex items-center">
                    <i class="fas fa-user text-gray-400 mr-3"></i>
                    <div>
                        <p class="font-medium text-gray-900">${user.full_name}</p>
                        <p class="text-sm text-gray-500">@${user.username} • ${user.email}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    searchResults.classList.remove('hidden');
}

function selectUser(userId, fullName, username, email) {
    selectedUser = { id: userId, fullName, username, email };
    
    // Mostrar usuario seleccionado
    document.getElementById('selected-user-name').textContent = fullName;
    document.getElementById('selected-user-info').textContent = `@${username} • ${email}`;
    document.getElementById('selected-user').classList.remove('hidden');
    document.getElementById('no-user-selected').classList.add('hidden');
    
    // Ocultar resultados de búsqueda
    document.getElementById('search-results').classList.add('hidden');
    document.getElementById('user-search').value = '';
    
    // Actualizar formulario
    document.getElementById('selected-user-id').value = userId;
    enableAssignmentForm();
    updateAssignmentSummary();
    
    // Limpiar selección
    document.getElementById('clear-selection').addEventListener('click', clearUserSelection);
}

function clearUserSelection() {
    selectedUser = null;
    document.getElementById('selected-user').classList.add('hidden');
    document.getElementById('no-user-selected').classList.remove('hidden');
    document.getElementById('selected-user-id').value = '';
    document.getElementById('assignment-summary').classList.add('hidden');
    disableAssignmentForm();
}

// Funciones del modal
function initializeModalHandlers() {
    document.getElementById('create-user-btn').addEventListener('click', () => {
        document.getElementById('create-user-modal').classList.remove('hidden');
        // Inicializar el mapa cuando se abre el modal
        setTimeout(() => {
            initializeUserLocationMap();
        }, 100);
    });
    
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('cancel-create-user').addEventListener('click', closeModal);
    
    document.getElementById('create-user-form').addEventListener('submit', handleCreateUser);
}

// Inicializar vista previa de foto
function initializePhotoPreview() {
    const photoInput = document.querySelector('input[name="foto_perfil"]');
    const photoPreview = document.getElementById('photo-preview');
    const previewImage = document.getElementById('preview-image');
    
    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validar tamaño (5MB máximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen no puede ser mayor a 5MB');
                    e.target.value = '';
                    photoPreview.classList.add('hidden');
                    return;
                }
                
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    alert('Solo se permiten archivos de imagen');
                    e.target.value = '';
                    photoPreview.classList.add('hidden');
                    return;
                }
                
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    photoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                photoPreview.classList.add('hidden');
            }
        });
    }
}

// Inicializar mapa de ubicación del usuario
function initializeUserLocationMap() {
    if (userLocationMap) {
        userLocationMap.remove();
    }
    
    // Coordenadas por defecto (Santa Cruz, Bolivia)
    const defaultLat = -17.78629;
    const defaultLng = -63.18117;
    
    userLocationMap = L.map('user-location-map').setView([defaultLat, defaultLng], 13);
    
    // Agregar tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(userLocationMap);
    
    // Manejar clicks en el mapa
    userLocationMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Actualizar campos de coordenadas
        document.getElementById('user-latitude').value = lat.toFixed(7);
        document.getElementById('user-longitude').value = lng.toFixed(7);
        
        // Remover marcador anterior si existe
        if (userLocationMarker) {
            userLocationMap.removeLayer(userLocationMarker);
        }
        
        // Agregar nuevo marcador
        userLocationMarker = L.marker([lat, lng])
            .addTo(userLocationMap)
            .bindPopup(`Ubicación seleccionada:<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`)
            .openPopup();
    });
    
    // Centrar el mapa al cargar
    setTimeout(() => {
        userLocationMap.invalidateSize();
    }, 250);
}

function closeModal() {
    document.getElementById('create-user-modal').classList.add('hidden');
    document.getElementById('create-user-form').reset();
    
    // Limpiar vista previa de foto
    document.getElementById('photo-preview').classList.add('hidden');
    
    // Limpiar mapa
    if (userLocationMap) {
        userLocationMap.remove();
        userLocationMap = null;
        userLocationMarker = null;
    }
    
    // Limpiar coordenadas
    document.getElementById('user-latitude').value = '';
    document.getElementById('user-longitude').value = '';
}

async function handleCreateUser(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch(`{% url 'sales_team_management:ajax_create_user' %}`, {
            method: 'POST',
            body: formData
        });
        
        // Verificar si la respuesta es exitosa
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server response error:', response.status, errorText);
            showNotification(`Error del servidor (${response.status}): ${response.statusText}`, 'error');
            return;
        }
        
        const data = await response.json();
        console.log('Server response data:', data);
        
        if (data.success) {
            // Seleccionar el usuario recién creado
            selectUser(data.user.id, data.user.full_name, data.user.username, data.user.email);
            closeModal();
            
            // Mostrar mensaje de éxito
            showNotification('Usuario creado exitosamente', 'success');
        } else {
            console.error('User creation failed:', data);
            if (data.errors) {
                // Mostrar errores de validación específicos
                const errorMessages = Object.entries(data.errors).map(([field, message]) => `${field}: ${message}`);
                showNotification(`Errores de validación:\n${errorMessages.join('\n')}`, 'error');
            } else {
                showNotification(data.error || data.message || 'Error al crear usuario', 'error');
            }
        }
    } catch (error) {
        console.error('Error creating user:', error);
        showNotification('Error al crear usuario', 'error');
    }
}

// Funciones del formulario de asignación
function initializeFormHandlers() {
    document.getElementById('team-select').addEventListener('change', handleTeamChange);
    document.getElementById('role-select').addEventListener('change', updateAssignmentSummary);
    document.getElementById('direct-supervision').addEventListener('change', handleSupervisionChange);
    document.getElementById('assignment-form').addEventListener('submit', handleAssignmentSubmit);
}

async function handleTeamChange(e) {
    const teamId = e.target.value;
    const roleSelect = document.getElementById('role-select');
    
    roleSelect.innerHTML = '<option value="">Seleccionar rol...</option>';
    
    if (!teamId) {
        updateAssignmentSummary();
        return;
    }
    
    try {
        const response = await fetch(`{% url 'sales_team_management:get_available_positions' 0 %}`.replace('0', teamId));
        const data = await response.json();
        
        if (data.success) {
            availablePositions = data.positions;
            data.positions.forEach(position => {
                const option = document.createElement('option');
                option.value = position.id;
                option.textContent = `${position.name} (Nivel ${position.hierarchy_level})`;
                roleSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading positions:', error);
    }
    
    updateAssignmentSummary();
}

function handleSupervisionChange(e) {
    const supervisorSelection = document.getElementById('supervisor-selection');
    if (e.target.checked) {
        supervisorSelection.classList.remove('hidden');
        loadSupervisors();
    } else {
        supervisorSelection.classList.add('hidden');
    }
    updateAssignmentSummary();
}

async function loadSupervisors() {
    const teamId = document.getElementById('team-select').value;
    if (!teamId) return;
    
    try {
        const response = await fetch(`{% url 'sales_team_management:get_team_members_json' 0 %}`.replace('0', teamId));
        const data = await response.json();
        
        if (data.success) {
            const supervisorSelect = document.querySelector('select[name="supervisor_id"]');
            supervisorSelect.innerHTML = '<option value="">Sin supervisor directo</option>';
            
            data.members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.user_name} (${member.position})`;
                supervisorSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading supervisors:', error);
    }
}

function enableAssignmentForm() {
    document.getElementById('create-assignment-btn').disabled = false;
    document.getElementById('create-assignment-btn').className = 'w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors cursor-pointer';
    document.getElementById('create-assignment-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Agregar al Equipo';
}

function disableAssignmentForm() {
    document.getElementById('create-assignment-btn').disabled = true;
    document.getElementById('create-assignment-btn').className = 'w-full bg-gray-300 text-gray-500 px-4 py-3 rounded-lg font-medium cursor-not-allowed';
    document.getElementById('create-assignment-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Agregar al Equipo';
}

function updateAssignmentSummary() {
    if (!selectedUser) return;
    
    const teamSelect = document.getElementById('team-select');
    const roleSelect = document.getElementById('role-select');
    const supervisionCheckbox = document.getElementById('direct-supervision');
    
    const summary = document.getElementById('assignment-summary');
    document.getElementById('summary-user').textContent = selectedUser.fullName;
    document.getElementById('summary-team').textContent = teamSelect.options[teamSelect.selectedIndex]?.text || 'No seleccionado';
    document.getElementById('summary-role').textContent = roleSelect.options[roleSelect.selectedIndex]?.text || 'No seleccionado';
    document.getElementById('summary-supervision').textContent = supervisionCheckbox.checked ? 'Sí' : 'No';
    
    if (teamSelect.value && roleSelect.value) {
        summary.classList.remove('hidden');
    } else {
        summary.classList.add('hidden');
    }
}

async function handleAssignmentSubmit(e) {
    e.preventDefault();
    
    if (!selectedUser) {
        showNotification('Debe seleccionar un usuario', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch(`{% url 'sales_team_management:agregar_miembro' 0 %}`.replace('0', formData.get('team_id')), {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Miembro agregado exitosamente al equipo', 'success');
            setTimeout(() => {
                window.location.href = `{% url 'sales_team_management:jerarquia_list' %}`;
            }, 1500);
        } else {
            showNotification(data.error || 'Error al agregar miembro', 'error');
        }
    } catch (error) {
        console.error('Error adding member:', error);
        showNotification('Error al agregar miembro', 'error');
    }
}

// Utilidades
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>

<style>
/* Estilos personalizados para el formulario */
input[type="text"], input[type="email"], input[type="password"], textarea, select {
    transition: all 0.2s ease;
}

input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

/* Animaciones para el modal */
#create-user-modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Mobile optimizations */
@media (max-width: 768px) {
    select, input {
        font-size: 16px !important;
        min-height: 44px !important;
    }
}
</style>
{% endblock %}