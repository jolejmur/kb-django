{% comment %}
    JavaScript functionality para la configuración de WhatsApp Business
    Incluye: Envío de mensajes, actualización en tiempo real, modales
{% endcomment %}
<script>
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = field.parentElement.querySelector('.toggle-password');
        
        if (field.tagName === 'TEXTAREA') {
            // Handle textarea visibility
            if (field.style.webkitTextSecurity === 'disc') {
                field.style.webkitTextSecurity = '';
                field.style.textSecurity = '';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.style.webkitTextSecurity = 'disc';
                field.style.textSecurity = 'disc';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        } else {
            // Handle input type change
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    }

    // DOM Ready
    document.addEventListener('DOMContentLoaded', function() {
        
        // Enviar mensaje de prueba
        const btnEnviarPrueba = document.getElementById('btn_enviar_prueba');
        if (btnEnviarPrueba) {
            btnEnviarPrueba.addEventListener('click', function() {
                const numeroDestino = document.getElementById('test_numero_destino').value;
                
                if (!numeroDestino.trim()) {
                    alert('Por favor ingresa un número de destino');
                    return;
                }
                
                // Deshabilitar botón y mostrar loading
                btnEnviarPrueba.disabled = true;
                btnEnviarPrueba.innerHTML = '<div class="loading-spinner me-2"></div>Enviando...';
                
                // Preparar datos (siempre template)
                const data = {
                    numero_destino: numeroDestino,
                    tipo: 'template',
                    template_name: 'hello_world',
                    language_code: 'en_US'
                };
                
                // Enviar mensaje
                fetch('/marketing/api/send-test-message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Mensaje enviado exitosamente!');
                        // Actualizar debug messages
                        actualizarDebugMessages();
                    } else {
                        alert('Error al enviar mensaje: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al enviar mensaje');
                })
                .finally(() => {
                    // Reactivar botón
                    btnEnviarPrueba.disabled = false;
                    btnEnviarPrueba.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Mensaje';
                });
            });
        }
        
        // Actualizar debug messages
        const btnActualizarDebug = document.getElementById('btn_actualizar_debug');
        if (btnActualizarDebug) {
            btnActualizarDebug.addEventListener('click', function() {
                actualizarDebugMessages();
            });
        }
        
        // Auto-actualizar debug messages cada 3 segundos para tiempo real
        setInterval(actualizarDebugMessages, 3000);
        
        // Actualizar inmediatamente cuando la ventana regresa al foco
        window.addEventListener('focus', function() {
            actualizarDebugMessages();
        });
    });
    
    // Función para actualizar mensajes de debug
    function actualizarDebugMessages() {
        const container = document.getElementById('debug_messages_container');
        const indicator = document.getElementById('live_indicator');
        
        if (!container) return;
        
        // Mostrar indicador de carga
        if (indicator) {
            indicator.className = 'badge bg-warning ms-2';
            indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        }
        
        fetch('/marketing/api/debug-messages/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderDebugMessages(data.data.messages);
                    
                    // Mostrar indicador de éxito
                    if (indicator) {
                        indicator.className = 'badge bg-info ms-2';
                        indicator.innerHTML = '<i class="fas fa-sync"></i> Polling (3s)';
                    }
                }
            })
            .catch(error => {
                console.error('Error al obtener mensajes de debug:', error);
                
                // Mostrar indicador de error
                if (indicator) {
                    indicator.className = 'badge bg-danger ms-2';
                    indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                }
            });
    }
    
    // Función para renderizar mensajes de debug
    function renderDebugMessages(messages) {
        const container = document.getElementById('debug_messages_container');
        if (!container) return;
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h5>No hay mensajes aún</h5>
                    <p>Los mensajes enviados y recibidos aparecerán aquí</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="message-list">';
        messages.forEach(message => {
            // Filtrar TODOS los mensajes de webhook_event - son ruido del sistema
            if (message.tipo === 'webhook_event') {
                return; // Skip ALL webhook events
            }
            
            // Filtrar mensajes de sistema adicionales que no necesitamos mostrar
            if (message.tipo === 'system' || message.tipo === 'status' || message.tipo === 'delivery' || message.tipo === 'read') {
                return; // Skip system messages
            }
            
            const typeClass = message.tipo === 'incoming' ? 'incoming' : 
                             message.tipo === 'outgoing' ? 'outgoing' : 
                             message.tipo === 'test_message' ? 'outgoing' : 'system';
            
            let iconHtml = '';
            let badgeHtml = '';
            
            if (message.tipo === 'incoming') {
                iconHtml = '<i class="fas fa-arrow-down" style="color: #4caf50;"></i>';
                badgeHtml = '<span class="badge" style="background-color: #4caf50; color: white;">📱 Recibido</span>';
            } else if (message.tipo === 'outgoing') {
                iconHtml = '<i class="fas fa-arrow-up" style="color: #2196f3;"></i>';
                badgeHtml = '<span class="badge" style="background-color: #2196f3; color: white;">📤 Enviado</span>';
            } else if (message.tipo === 'test_message') {
                iconHtml = '<i class="fas fa-vial" style="color: #ff9800;"></i>';
                badgeHtml = '<span class="badge" style="background-color: #ff9800; color: white;">🧪 Prueba</span>';
            } else {
                // Para cualquier mensaje no filtrado que llegue aquí
                iconHtml = '<i class="fas fa-cog" style="color: #6c757d;"></i>';
                badgeHtml = '<span class="badge" style="background-color: #6c757d; color: white;">Sistema</span>';
            }
            
            const date = new Date(message.created_at);
            const timeString = date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Estilos inline completos para evitar pérdida de colores
            let itemStyle = 'padding: 1rem !important; border-radius: 8px !important; margin-bottom: 1rem !important; transition: all 0.3s ease !important;';
            if (message.tipo === 'incoming') {
                itemStyle += 'background: linear-gradient(135deg, #e8f5e9, #f1f8e9) !important; border-left: 4px solid #4caf50 !important; border: 1px solid #c8e6c9 !important; box-shadow: 0 2px 4px rgba(76, 175, 80, 0.1) !important;';
            } else if (message.tipo === 'outgoing') {
                itemStyle += 'background: linear-gradient(135deg, #e3f2fd, #f0f7ff) !important; border-left: 4px solid #2196f3 !important; border: 1px solid #bbdefb !important; box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1) !important;';
            } else if (message.tipo === 'test_message') {
                itemStyle += 'background: linear-gradient(135deg, #fff3e0, #ffecb3) !important; border-left: 4px solid #ff9800 !important; border: 1px solid #ffcc02 !important; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.1) !important;';
            } else {
                itemStyle += 'background: linear-gradient(135deg, #fafafa, #f5f5f5) !important; border-left: 4px solid #9e9e9e !important; border: 1px solid #e0e0e0 !important; box-shadow: 0 2px 4px rgba(158, 158, 158, 0.1) !important;';
            }
            
            html += `
                <div class="message-item ${typeClass}" style="${itemStyle}">
                    <div class="message-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div class="message-type" style="display: flex; align-items: center; gap: 0.5rem;">
                            ${iconHtml}
                            ${badgeHtml}
                        </div>
                        <div class="message-phone" style="font-weight: 600; color: #1877f2;">${message.numero_telefono}</div>
                        <div class="message-time" style="font-size: 0.8rem; color: #6c757d;">${timeString}</div>
                    </div>
                    <div class="message-content" style="color: #212529; line-height: 1.4; word-wrap: break-word;">
                        ${message.contenido}
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    // Utility functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Modal functionality
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Field editing functionality
    function editField(fieldName, currentValue) {
        // This would be implemented based on the modal functionality
        // For now, just placeholder
        console.log('Edit field:', fieldName, currentValue);
        alert('Funcionalidad de edición en desarrollo');
    }

    function createNewConfig() {
        // Show create config modal
        showModal('createConfigModal');
    }
</script>